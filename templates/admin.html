<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Administraci√≥n</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color: #f7f9fc; font-family: 'Segoe UI', sans-serif; }
h1 { text-align: center; color: #0077b6; margin-top: 20px; }
.alerta-card { margin: 10px auto; width: 90%; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); cursor: pointer; transition: 0.3s; }
.tachado { opacity: 0.6; text-decoration: line-through; }
.urgencia-bajo { border-left: 6px solid #28a745; }
.urgencia-medio { border-left: 6px solid #ffc107; }
.urgencia-alto { border-left: 6px solid #dc3545; }
.icon-button { position: fixed; top: 10px; width: 45px; height: 45px; border-radius: 50%; background: white; border: none; font-size: 22px; box-shadow: 0 0 5px rgba(0,0,0,0.2); cursor: pointer; display: flex; justify-content: center; align-items: center; }
.back-button { left: 10px; }
.logout-button { right: 10px; }
.filter-input { width: 200px; margin-right: 10px; }
.stats { text-align: center; margin-bottom: 20px; }
</style>
</head>
<body>

<button class="icon-button back-button" onclick="window.location.href='https://tu-link-canva-celular'">‚Üê</button>
<button class="icon-button logout-button" onclick="window.location.href='/logout'">üë§</button>

<h1>Panel de Administraci√≥n</h1>

<div class="stats">
    <input type="text" id="busqueda" class="form-control filter-input d-inline" placeholder="Buscar camilla o necesidad">
    <select id="filtroUrgencia" class="form-select filter-input d-inline">
        <option value="">Todas urgencias</option>
        <option value="baja">Baja</option>
        <option value="media">Media</option>
        <option value="alta">Alta</option>
    </select>
    <button class="btn btn-danger" onclick="limpiarAlertas()">üßπ Limpiar Alertas</button>
</div>

<div id="contenedor-alertas"></div>

<script src="/static/alertas.js"></script>
<script>
function renderAlerta(data) {
    let urgenciaClase = data.urgencia === 'baja' ? 'urgencia-bajo' : data.urgencia === 'media' ? 'urgencia-medio' : 'urgencia-alto';
    let id = data.camilla + '-' + data.hora + '-' + data.necesidad;
    let tachado = data.tachado ? 'tachado' : '';
    return `<div class="card alerta-card ${urgenciaClase} ${tachado}" data-id="${id}">
        <div class="card-body">
            <h5 class="card-title">Camilla: ${data.camilla}</h5>
            <p class="card-text"><strong>Hora:</strong> ${data.hora}</p>
            ${data.patologia ? <p class="card-text"><strong>Patolog√≠a:</strong> ${data.patologia}</p> : ''}
            <p class="card-text"><strong>Urgencia:</strong> ${data.urgencia}</p>
            <p class="card-text"><strong>Necesidad:</strong> ${data.necesidad}</p>
        </div>
    </div>`;
}

let todasAlertas = [];

function actualizarAlertas() {
    fetch('/datos')
        .then(res => res.json())
        .then(alertas => {
            todasAlertas = alertas;
            filtrarAlertas();
        });
}

function limpiarAlertas() {
    fetch('/limpiar', { method:'POST' }).then(() => actualizarAlertas());
}

function filtrarAlertas() {
    const busqueda = document.getElementById('busqueda').value.toLowerCase();
    const urgenciaFiltro = document.getElementById('filtroUrgencia').value;
    let filtradas = todasAlertas.filter(a => {
        let coincideBusqueda = a.camilla.toLowerCase().includes(busqueda) || a.necesidad.toLowerCase().includes(busqueda);
        let coincideUrgencia = urgenciaFiltro === '' || a.urgencia === urgenciaFiltro;
        return coincideBusqueda && coincideUrgencia;
    });
    document.getElementById('contenedor-alertas').innerHTML = filtradas.map(renderAlerta).join('');
}

setInterval(actualizarAlertas, 2000);
window.onload = actualizarAlertas;

document.getElementById('busqueda').addEventListener('input', filtrarAlertas);
document.getElementById('filtroUrgencia').addEventListener('change', filtrarAlertas);

document.addEventListener('click', function(e){
    if(e.target.closest('.alerta-card')){
        let id = e.target.closest('.alerta-card').dataset.id;
        fetch('/tachar', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id}) })
        .then(() => actualizarAlertas());
    }
});
</script>
</body>
</html>
